data.table包
================
newbiejasper
2017/3/28

data.table包是干什么的
======================

R语言里有data.frame的数据结构。data.table是data.frame的一个扩展，它几乎继承了所有的data.frame特性，我们通常对data.frame作出的操作，对于data.table同样也是有效的。那么data.table存在的价值是什么呢？它是由C语言写的，所以运行速度快，数据存储效率高，像取子集，变量分组，更新变量等操作都要优于data.frame，而且对于大型数据集的支持比较好。所以，如果你还没有学习过data.frame，可以直接越过它直接学习data.table。

实例中学习
==========

创建数据集
----------

创建data.frame

``` r
df <- data.frame(x=rnorm(9),y=rep(c('a','b','c'),each=3),z=rnorm(9))
head(df,n=3)
```

    ##            x y          z
    ## 1 -2.3073716 a  1.5705973
    ## 2  0.5453968 a -1.0604976
    ## 3  0.3161931 a -0.6694775

创建data.table

``` r
library(data.table)
dt <- data.table(x=rnorm(9),y=rep(c('a','b','c'),each=3),z=rnorm(9))
head(dt,n=3)
```

    ##             x y            z
    ## 1:  0.2215434 a -0.036959138
    ## 2:  0.1305816 a -0.000746413
    ## 3: -0.4680529 a -0.416177115

查看内存下所有的data table的情况

``` r
tables()
```

    ##      NAME NROW NCOL MB COLS  KEY
    ## [1,] dt      9    3  1 x,y,z    
    ## Total: 1MB

像data.frame一样进行操作
------------------------

``` r
dt[2,] #取第二行，所有列
```

    ##            x y            z
    ## 1: 0.1305816 a -0.000746413

``` r
dt[dt$y=="a",] #取dt表中y列取值为"a"的所有行
```

    ##             x y            z
    ## 1:  0.2215434 a -0.036959138
    ## 2:  0.1305816 a -0.000746413
    ## 3: -0.4680529 a -0.416177115

和data.frame的区别
------------------

``` r
dt[c(2,3)]  #data.table中索引没有逗号，默认是按行取，这里取出的是第2，3行
```

    ##             x y            z
    ## 1:  0.1305816 a -0.000746413
    ## 2: -0.4680529 a -0.416177115

``` r
df[c(2,3)]   #data.frame没有逗号默认是按列取得，这里取出了第2，3列
```

    ##   y          z
    ## 1 a  1.5705973
    ## 2 a -1.0604976
    ## 3 a -0.6694775
    ## 4 b -0.8039125
    ## 5 b  1.2905721
    ## 6 b  2.0818057
    ## 7 c  1.5427769
    ## 8 c -1.5365087
    ## 9 c -0.1860371

取子集操作
----------

1.  data.table包用来取子集的函数与R中常用数据类型有些不同。
2.  它采用：逗号+expression 的表达方式。
3.  一个 expression 是指包含在一对花括号里的一系列语句。

### 例1

设想你想要求出x这一列的均值，z这一列的总和：

``` r
dt[,list(mean(x),sum(z))]
```

    ##           V1        V2
    ## 1: 0.3370235 -1.361172

### 例2

设想你想要对y变量各种值出现的频次做个统计

``` r
dt[,table(y)]
```

    ## y
    ## a b c 
    ## 3 3 3

### 例3

设想你想生成新的一列，新列是z那一列的平方

``` r
dt[,w:=z^2]
```

这里用 data.table，而不是用 data.frame 的好处就体现出来了，data.table 是直接在原来的表里添加新的一列，而 data.frame 要重新生成一个表，再把新列加进去，所以当数据集很大时，非常占内存，速度也会下降。

### 例4

``` r
dt2 <- dt
dt[,y:=2]
head(dt,3)
```

    ##             x y            z            w
    ## 1:  0.2215434 2 -0.036959138 1.365978e-03
    ## 2:  0.1305816 2 -0.000746413 5.571323e-07
    ## 3: -0.4680529 2 -0.416177115 1.732034e-01

``` r
head(dt2,3)
```

    ##             x y            z            w
    ## 1:  0.2215434 2 -0.036959138 1.365978e-03
    ## 2:  0.1305816 2 -0.000746413 5.571323e-07
    ## 3: -0.4680529 2 -0.416177115 1.732034e-01

这里，我们把dt赋值给了dt2，然后修改了dt的值，发现dt2的值也被修改了。也就是说dt和dt2在内存中占用的是同一个地方，并没有做到真正的复制。这里我们需要用 copy 函数来进行真正的复制。

``` r
dt3 <- copy(dt)
dt[,y:=3]
head(dt,n=3)
```

    ##             x y            z            w
    ## 1:  0.2215434 3 -0.036959138 1.365978e-03
    ## 2:  0.1305816 3 -0.000746413 5.571323e-07
    ## 3: -0.4680529 3 -0.416177115 1.732034e-01

``` r
head(dt3,n=3)
```

    ##             x y            z            w
    ## 1:  0.2215434 2 -0.036959138 1.365978e-03
    ## 2:  0.1305816 2 -0.000746413 5.571323e-07
    ## 3: -0.4680529 2 -0.416177115 1.732034e-01

多条expression的情形
--------------------

这里我们创建一个叫做 m 的新列，这个表达式包含两个语句，放在一个花括号里，语句之间用分号隔开，最后的返回值就是新列的值。

``` r
dt[,m:={tmp=x+z;log(abs(tmp)+2)}]
head(dt,n=3)
```

    ##             x y            z            w         m
    ## 1:  0.2215434 3 -0.036959138 1.365978e-03 0.7814255
    ## 2:  0.1305816 3 -0.000746413 5.571323e-07 0.7560446
    ## 3: -0.4680529 3 -0.416177115 1.732034e-01 1.0592580

逻辑值的情形
------------

在对数据进行分组时，常常依据一些判断条件，例如下面对 a 的正负性进行分组。

``` r
dt[,a:=x>0]
head(dt)
```

    ##              x y            z            w         m     a
    ## 1:  0.22154342 3 -0.036959138 1.365978e-03 0.7814255  TRUE
    ## 2:  0.13058158 3 -0.000746413 5.571323e-07 0.7560446  TRUE
    ## 3: -0.46805293 3 -0.416177115 1.732034e-01 1.0592580 FALSE
    ## 4: -0.04218963 3  0.006306522 3.977222e-05 0.7109297 FALSE
    ## 5:  0.83961783 3  0.417750685 1.745156e-01 1.1809197  TRUE
    ## 6: -1.00831444 3 -1.070324894 1.145595e+00 1.4057634 FALSE

分组之后就可以求出不同组的一些特征，例如

``` r
dt[,b:=mean(x+w),by=a]
head(dt)
```

    ##              x y            z            w         m     a           b
    ## 1:  0.22154342 3 -0.036959138 1.365978e-03 0.7814255  TRUE  1.29951613
    ## 2:  0.13058158 3 -0.000746413 5.571323e-07 0.7560446  TRUE  1.29951613
    ## 3: -0.46805293 3 -0.416177115 1.732034e-01 1.0592580 FALSE -0.06657282
    ## 4: -0.04218963 3  0.006306522 3.977222e-05 0.7109297 FALSE -0.06657282
    ## 5:  0.83961783 3  0.417750685 1.745156e-01 1.1809197  TRUE  1.29951613
    ## 6: -1.00831444 3 -1.070324894 1.145595e+00 1.4057634 FALSE -0.06657282

``` r
dt[,.N,by=a]
```

    ##        a N
    ## 1:  TRUE 6
    ## 2: FALSE 3
